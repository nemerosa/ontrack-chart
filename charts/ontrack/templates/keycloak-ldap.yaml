{{- if and .Values.auth.keycloak.enabled (not .Values.auth.keycloak.external.enabled) .Values.auth.keycloak.ldap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ontrack.fullname" . }}-keycloak-ldap
data:
  ontrack.json: |-
    {
      "id": "{{ .Values.auth.keycloak.realm }}",
      "realm": "{{ .Values.auth.keycloak.realm }}",
      "enabled": true,
      "registrationAllowed": {{ .Values.auth.keycloak.settings.registrationAllowed }},
      "resetPasswordAllowed": {{ .Values.auth.keycloak.settings.resetPasswordAllowed }},
      "users": [
        {
          "username": "{{ .Values.auth.keycloak.settings.admin.username }}",
          "enabled": true,
          "email": "{{ .Values.auth.keycloak.settings.admin.email | default .Values.auth.admin.email }}",
          "firstName": "{{ .Values.auth.keycloak.settings.admin.firstName }}",
          "lastName": "{{ .Values.auth.keycloak.settings.admin.lastName }}",
          "emailVerified": true,
          "credentials": [
            {
              "type": "password",
              "value": "{{ .Values.auth.keycloak.settings.admin.password }}"
            }
          ]
        }
      ],
      "clients": [
        {
          "clientId": "{{ .Values.auth.keycloak.client.id }}",
          "enabled": true,
          "protocol": "openid-connect",
          "publicClient": false,
          "baseUrl": "{{ .Values.ontrack.url }}",
          "redirectUris": [
            "{{ .Values.ontrack.url }}/api/auth/callback/keycloak"
          ],
          "webOrigins": [
            "{{ .Values.ontrack.url }}"
          ],
          "directAccessGrantsEnabled": true,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "clientAuthenticatorType": "client-secret",
          "secret": "{{ .Values.auth.keycloak.client.secret }}"
        }
      ],
      "components": {
        "org.keycloak.storage.UserStorageProvider": [
          {
            "id": "{{ .Values.auth.keycloak.ldap.id }}",
            "name": "{{ .Values.auth.keycloak.ldap.name }}",
            "providerId": "ldap",
            "config": {
              "enabled": ["true"],
              "priority": ["0"],
              "editMode": ["READ_ONLY"],
              "importEnabled": ["false"],
              "syncRegistrations": ["false"],
              "vendor": ["other"],
              "connectionUrl": ["{{ .Values.auth.keycloak.ldap.url }}"],
              "usersDn": ["{{ .Values.auth.keycloak.ldap.usersDn }}"],
              "bindDn": ["{{ .Values.auth.keycloak.ldap.bindDn }}"],
              "bindCredential": ["{{ .Values.auth.keycloak.ldap.bindCredential }}"],
              "useTruststoreSpi": ["ldapsOnly"],
              "connectionPooling": ["true"],
              "pagination": ["true"],
              "batchSizeForSync": ["1000"],
              "usernameLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.usernameLDAPAttribute }}"],
              "rdnLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.rdnLDAPAttribute }}"],
              "uuidLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.uuidLDAPAttribute }}"],
              "userObjectClasses": ["{{ .Values.auth.keycloak.ldap.userObjectClasses }}"],
              "searchScope": ["1"],
              "validatePasswordPolicy": ["false"],
              "trustEmail": ["true"]
            }
          }
        ]
      }
    }
{{- end }}
