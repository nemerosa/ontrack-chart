{{- if and .Values.auth.keycloak.enabled (not .Values.auth.keycloak.external.enabled) .Values.auth.keycloak.ldap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ontrack.fullname" . }}-keycloak-ldap-template
data:
  ontrack.json.tpl: |-
    {
      "id": "{{ .Values.auth.keycloak.realm }}",
      "realm": "{{ .Values.auth.keycloak.realm }}",
      "enabled": true,
      "registrationAllowed": {{ .Values.auth.keycloak.settings.registrationAllowed }},
      "resetPasswordAllowed": {{ .Values.auth.keycloak.settings.resetPasswordAllowed }},
      "clients": [
        {
          "clientId": "{{ .Values.auth.keycloak.client.id }}",
          "enabled": true,
          "protocol": "openid-connect",
          "publicClient": false,
          "baseUrl": "{{ .Values.ontrack.url }}",
          "redirectUris": [
            "{{ .Values.ontrack.url }}/api/auth/callback/keycloak"
          ],
          "webOrigins": [
            "{{ .Values.ontrack.url }}"
          ],
          "directAccessGrantsEnabled": true,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "clientAuthenticatorType": "client-secret",
          "secret": "{{ .Values.auth.keycloak.client.secret }}"
        }
      ],
      "components": {
        "org.keycloak.storage.UserStorageProvider": [
          {
            "id": "{{ .Values.auth.keycloak.ldap.id }}",
            "name": "{{ .Values.auth.keycloak.ldap.name }}",
            "providerId": "ldap",
            "subComponents": {
              "org.keycloak.storage.ldap.mappers.LDAPStorageMapper": [
                {
                  "name": "email",
                  "providerId": "user-attribute-ldap-mapper",
                  "config": {
                    "ldap.attribute": [
                      "mail"
                    ],
                    "is.mandatory.in.ldap": [
                      "true"
                    ],
                    "read.only": [
                      "true"
                    ],
                    "always.read.value.from.ldap": [
                      "true"
                    ],
                    "user.model.attribute": [
                      "email"
                    ]
                  }
                },
                {
                  "name": "username",
                  "providerId": "user-attribute-ldap-mapper",
                  "config": {
                    "ldap.attribute": [
                      "uid"
                    ],
                    "is.mandatory.in.ldap": [
                      "true"
                    ],
                    "always.read.value.from.ldap": [
                      "true"
                    ],
                    "read.only": [
                      "true"
                    ],
                    "user.model.attribute": [
                      "username"
                    ]
                  }
                }
              ]
            },
            "config": {
              "enabled": ["true"],
              "priority": ["0"],
              "editMode": ["READ_ONLY"],
              "importEnabled": ["false"],
              "syncRegistrations": ["false"],
              "vendor": ["other"],
              "connectionUrl": ["{{ .Values.auth.keycloak.ldap.url }}"],
              "usersDn": ["{{ .Values.auth.keycloak.ldap.usersDn }}"],
              "bindDn": ["${BIND_DN}"],
              "bindCredential": ["${BIND_CREDENTIAL}"],
              "useTruststoreSpi": ["ldapsOnly"],
              "connectionPooling": ["true"],
              "pagination": ["true"],
              "batchSizeForSync": ["1000"],
              "usernameLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.usernameLDAPAttribute }}"],
              "rdnLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.rdnLDAPAttribute }}"],
              "uuidLDAPAttribute": ["{{ .Values.auth.keycloak.ldap.uuidLDAPAttribute }}"],
              "userObjectClasses": ["{{ .Values.auth.keycloak.ldap.userObjectClasses }}"],
              "searchScope": ["1"],
              "validatePasswordPolicy": ["false"],
              "trustEmail": ["true"]
            }
          }
        ]
      }
    }
{{- end }}
